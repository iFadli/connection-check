<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connectivity Check</title>
  <style>
    :root {
      --bg: #f5f7fb; --card: #ffffff; --text: #0f172a; --muted: #64748b;
      --ok: #16a34a; --fail: #dc2626; --border: #e2e8f0;
      --accent1: #0ea5e9; --accent2: #6366f1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text); padding: 24px 12px;
    }
    .wrap { width: min(960px, 100%); }
    .hero {
      background: var(--card); border-radius: 18px; border: 1px solid var(--border);
      box-shadow: 0 18px 48px rgba(15,23,42,0.08);
      padding: clamp(16px, 3vw, 28px); text-align: center;
    }
    .title { font-size: clamp(22px, 3vw, 28px); margin: 0 0 8px; }
    .subtitle { margin: 0 0 16px; color: var(--muted); font-size: 14px; }
    .speed-circle {
      width: 180px; height: 180px; margin: 18px auto;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff, #e0e7ff);
      display: flex; align-items: center; justify-content: center;
      box-shadow: inset 0 0 0 10px #e5e7eb, 0 16px 40px rgba(99,102,241,0.18);
    }
    .start-btn {
      width: 140px; height: 140px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; font-size: 18px; font-weight: 700; cursor: pointer;
      box-shadow: 0 12px 28px rgba(14,165,233,0.28);
      transition: transform .1s ease, box-shadow .15s ease;
    }
    .start-btn:active { transform: scale(0.97); box-shadow: 0 8px 18px rgba(14,165,233,0.22); }
    .status { font-size: 15px; font-weight: 700; margin-top: 10px; }
    .ok { color: var(--ok); } .fail { color: var(--fail); }

    .summary-chip {
      margin: 10px auto 6px;
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border);
      background: #eef2ff; color: #312e81; font-weight: 700;
    }
    .summary-chip.ok { background: #e7f6ed; color: var(--ok); }
    .summary-chip.warn { background: #fff4e5; color: #d97706; }
    .summary-chip.fail { background: #fdecec; color: var(--fail); }
    .hidden { display: none !important; }

    .actions { margin: 12px auto 12px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .share-btn, .copy-btn {
      border: none; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer;
      color: #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }
    .share-btn { background: #10b981; }
    .copy-btn { background: #475569; }

    .divider {
      margin: 12px 0 8px;
      border: 0; border-top: 1px solid var(--border);
    }

    .summary {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px; margin-top: 8px; text-align: left;
    }
    .card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .label { font-size: 13px; color: var(--muted); margin-bottom: 4px; }
    .value { font-size: 14px; font-weight: 600; word-break: break-word; }

    .list { margin: 12px 0 0; padding: 4px; list-style: none; text-align: left;
      border: 1px solid var(--border); border-radius: 12px; background: #fff; }
    .list li { padding: 12px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .list li:last-child { border-bottom: none; }
    .svc-name { font-weight: 600; color: var(--text); }
    .svc-note { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .pill { padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; min-width: 90px; text-align: center; }
    .pill.ok { background: #e7f6ed; color: var(--ok); }
    .pill.fail { background: #fdecec; color: var(--fail); }

    pre {
      background: #0f172a; color: #e2e8f0; border-radius: 12px; padding: 12px;
      margin-top: 12px; font-size: 13px; overflow-x: auto; white-space: pre-wrap; text-align: left;
    }
    @media (max-width: 540px) {
      .speed-circle { width: 150px; height: 150px; }
      .start-btn { width: 120px; height: 120px; font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="title">Connectivity Check</div>
      <div class="subtitle">Tes cepat koneksi umum dan akses service (contoh: Firestore). HTTP 2xx/3xx/4xx = terhubung.</div>

      <div class="speed-circle">
        <button id="run" class="start-btn">Start</button>
      </div>

      <div class="status" id="statusText"></div>
      <div class="summary-chip hidden" id="summaryChip">-</div>

      <div class="actions hidden" id="shareRow">
        <button class="share-btn" id="shareWa">Bagikan hasil via WhatsApp</button>
        <button class="copy-btn" id="copyBtn">Salin hasil tes</button>
      </div>

      <hr class="divider" />

      <div class="summary">
        <div class="card">
          <div class="label">IP Publik</div>
          <div class="value" id="ip">-</div>
        </div>
        <div class="card">
          <div class="label">Device / User Agent</div>
          <div class="value" id="ua">-</div>
        </div>
      </div>

      <ul class="list" id="list"></ul>
      <pre id="log">Tekan Start untuk memulai.</pre>
    </div>
  </div>

  <script>
    const tests = [
      { name: 'Internet (Google 204)', url: 'https://www.google.com/generate_204' },
      { name: 'Firestore Root', url: 'https://firestore.googleapis.com/' },
      { name: 'GStatic FirebaseJS', url: 'https://www.gstatic.com/firebasejs/' },
    ];
    const runBtn = document.getElementById('run');
    const statusText = document.getElementById('statusText');
    const logEl = document.getElementById('log');
    const ipEl = document.getElementById('ip');
    const uaEl = document.getElementById('ua');
    const listEl = document.getElementById('list');
    const shareBtn = document.getElementById('shareWa');
    const copyBtn = document.getElementById('copyBtn');
    const shareRow = document.getElementById('shareRow');
    const summaryChip = document.getElementById('summaryChip');

    const setStatus = (txt, ok) => { statusText.textContent = txt; statusText.className = 'status ' + (ok ? 'ok' : 'fail'); };
    const isReachable = (resp) => resp && resp.status > 0;
    const line = (label, res) => res.ok
      ? `${label}: OK (status ${res.status}, ${res.time} ms)`
      : `${label}: FAIL (${res.error || 'network/SSL error'})`;

    function renderList(results) {
      listEl.innerHTML = '';
      results.forEach(({ label, res }) => {
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.innerHTML = `<div class="svc-name">${label}</div><div class="svc-note">${res.ok ? 'Terhubung' : 'Tidak terhubung'}</div>`;
        const pill = document.createElement('div');
        pill.className = 'pill ' + (res.ok ? 'ok' : 'fail');
        pill.textContent = res.ok ? `OK (${res.status})` : 'FAIL';
        li.appendChild(left); li.appendChild(pill); listEl.appendChild(li);
      });
    }

    function setSummary(results) {
      const total = results.length;
      if (!total) { summaryChip.className = 'summary-chip hidden'; return; }
      const okCount = results.filter(r => r.res.ok).length;
      const failCount = total - okCount;
      let text = ''; let cls = 'warn';
      if (failCount === 0) { text = `Semua Normal | ${okCount}/${total}`; cls = 'ok'; }
      else if (okCount === 0) { text = `Semua Bermasalah | 0/${total}`; cls = 'fail'; }
      else { text = `Beberapa Bermasalah | ${okCount}/${total}`; cls = 'warn'; }
      summaryChip.textContent = text;
      summaryChip.className = `summary-chip ${cls}`;
    }

    function formatDateWIB() {
      const date = new Date();
      const opts = { timeZone: 'Asia/Jakarta', hour12: false };
      const locale = date.toLocaleString('en-GB', opts); // dd/mm/yyyy, hh:mm:ss
      return locale.replace(',', '');
    }

    function buildShareText(ip, ua, results) {
      return [
        '[Connectivity Check]',
        `IP Public : ${ip}`,
        `User-Agent : ${ua}`,
        '----------------',
        ...results.map(r => r.res.ok
          ? `- ${r.label}: OK (status ${r.res.status}, ${r.res.time} ms)`
          : `- ${r.label}: FAIL (${r.res.error || 'network/SSL error'})`
        ),
        '----------------',
        `Waktu Test : ${formatDateWIB()} (WIB)`
      ].join('\n');
    }

    async function runTest(t) {
      const start = performance.now();
      try {
        const resp = await fetch(t.url, { method: 'GET' });
        const body = await resp.text();
        return { ok: isReachable(resp), status: resp.status, time: Math.round(performance.now() - start), body: body.slice(0, 120) };
      } catch (e) {
        return { ok: false, error: e.toString() };
      }
    }

    async function getIp() {
      try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); return d.ip; }
      catch { return 'unknown'; }
    }

    async function runAll() {
      setStatus('Memeriksa Jaringan...', true);
      logEl.textContent = 'Memeriksa Jaringan...';
      ipEl.textContent = '...';
      uaEl.textContent = navigator.userAgent;
      listEl.innerHTML = '';
      shareRow.classList.add('hidden');
      summaryChip.className = 'summary-chip hidden';

      const ip = await getIp();
      ipEl.textContent = ip;

      const results = [];
      for (const t of tests) results.push({ label: t.name, res: await runTest(t) });

      const hasFail = results.some(r => !r.res.ok);
      setStatus(hasFail ? 'Jaringan Tidak Stabil' : 'Jaringan Stabil', !hasFail);
      logEl.textContent = results.map(r => line(r.label, r.res)).join('\n');
      renderList(results);
      // setSummary(results);

      const shareText = buildShareText(ip, navigator.userAgent, results);
      shareBtn.onclick = () => { const text = encodeURIComponent(shareText); window.open(`https://wa.me/?text=${text}`, '_blank'); };
      copyBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(shareText); copyBtn.textContent = 'Tersalin!'; setTimeout(() => copyBtn.textContent = 'Salin hasil tes', 1600); }
        catch { copyBtn.textContent = 'Gagal menyalin'; setTimeout(() => copyBtn.textContent = 'Salin hasil tes', 1600); }
      };

      shareRow.classList.remove('hidden');
      runBtn.textContent = 'Periksa Ulang';
    }

    runBtn.addEventListener('click', runAll);
  </script>
</body>
</html>
